#include "tinytb.dtsi"
#include <input/processors.dtsi>
#include <zephyr/dt-bindings/input/input-event-codes.h>
#include <dt-bindings/zmk/input_transform.h>

/* keymap と同じレイヤー番号に揃える */
#define BASE    0
#define ROT_90  1
#define ROT_180 2
#define ROT_270 3
#define L1      4
#define L2      5
#define L3      6
#define L4      7

/* （ここはあなたの既存の kscan / spi / pmw3610 定義そのままでOK） */
/* pmw3610 デバイスのラベルが "trackball:" なら &trackball で参照できる */

 /{
  /* 入力リスナー本体（デバイスを監視し、レイヤーに応じて変換） */
  trackball_listener: trackball_listener {
    compatible = "zmk,input-listener";
    status = "okay";
    device = <&trackball>;               /* ★必須：監視するセンサーを指定 */

    /* === カーソル回転（本体の向き） ===
       基準（0°）は変換なし！ここを (0) にしておくのがコツ */
    input-processors = <&zip_xy_transform (0)>;

    /* 90° = XY入替 + X反転 */
    rot90  { layers = <ROT_90>;
      input-processors = <&zip_xy_transform (INPUT_TRANSFORM_XY_SWAP | INPUT_TRANSFORM_X_INVERT)>;
    };

    /* 180° = X反転 + Y反転 */
    rot180 { layers = <ROT_180>;
      input-processors = <&zip_xy_transform (INPUT_TRANSFORM_X_INVERT | INPUT_TRANSFORM_Y_INVERT)>;
    };

    /* 270° = XY入替 + Y反転 */
    rot270 { layers = <ROT_270>;
      input-processors = <&zip_xy_transform (INPUT_TRANSFORM_XY_SWAP | INPUT_TRANSFORM_Y_INVERT)>;
    };

    /* === スクロール変換（押している間だけ L1〜L4 に移動して有効化） === */

    /* L1: 縦（正）—逆に感じたら下の Y_INVERT を有効化 */
    scroller_v { layers = <L1>;
      input-processors =
        <&zip_xy_transform (0)>,
        <&zip_xy_to_scroll_mapper>,
        /* <&zip_scroll_transform (INPUT_TRANSFORM_Y_INVERT)>, */ /* ←必要ならON */
        <&zip_scroll_scaler 1 1>;   /* 等倍。速くしたいなら 2 1 等 */
    };

    /* L2: 横（正）—逆に感じたら X_INVERT を有効化 */
    scroller_h { layers = <L2>;
      input-processors =
        <&zip_xy_transform (INPUT_TRANSFORM_XY_SWAP)>,
        <&zip_xy_to_scroll_mapper>,
        /* <&zip_scroll_transform (INPUT_TRANSFORM_X_INVERT)>, */
        <&zip_scroll_scaler 1 1>;
    };

    /* L3: 縦（反転） */
    scroller_v_inv { layers = <L3>;
      input-processors =
        <&zip_xy_transform (0)>,
        <&zip_xy_to_scroll_mapper>,
        <&zip_scroll_transform (INPUT_TRANSFORM_Y_INVERT)>,
        <&zip_scroll_scaler 1 1>;
    };

    /* L4: 横（反転） */
    scroller_h_inv { layers = <L4>;
      input-processors =
        <&zip_xy_transform (INPUT_TRANSFORM_XY_SWAP)>,
        <&zip_xy_to_scroll_mapper>,
        <&zip_scroll_transform (INPUT_TRANSFORM_X_INVERT)>,
        <&zip_scroll_scaler 1 1>;
    };
  };
};
